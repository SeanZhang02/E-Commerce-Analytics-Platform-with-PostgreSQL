# Business Calculations Documentation

## Overview
This document defines all business calculations, KPIs, and formulas used in the E-Commerce Sales Analytics platform. All calculations are implemented consistently across SQL queries to ensure data integrity and business alignment.

## Core Financial Metrics

### Revenue Calculation
**Definition**: Total income from product sales after discounts
**Formula**: `SUM(unit_price * quantity * (1 - discount))`
**Data Source**: `internal.order_details` joined with `internal.orders`
**Business Context**: Primary revenue metric for performance tracking

```sql
-- Standard Revenue Query
SELECT 
    SUM(od.unit_price * od.quantity * (1 - od.discount)) as revenue
FROM internal.orders o
JOIN internal.order_details od ON o.order_id = od.order_id
WHERE o.order_date BETWEEN '2023-01-01' AND '2023-12-31';
```

### Average Order Value (AOV)
**Definition**: Average revenue per order
**Formula**: `Total Revenue / Order Count`
**Target Range**: $40-60 (industry benchmark: $53)
**Business Context**: Indicates customer purchasing power and upselling effectiveness

```sql
-- AOV Calculation
SELECT 
    ROUND(SUM(od.unit_price * od.quantity * (1 - od.discount)) / 
          NULLIF(COUNT(DISTINCT o.order_id), 0), 2) as avg_order_value
FROM internal.orders o
JOIN internal.order_details od ON o.order_id = od.order_id;
```

### Growth Rate Calculations
**Year-over-Year (YoY)**: `((Current Period - Previous Year Period) / Previous Year Period) * 100`
**Month-over-Month (MoM)**: `((Current Month - Previous Month) / Previous Month) * 100`
**Industry Benchmark**: 20.5% annual growth rate for e-commerce

```sql
-- YoY Growth Rate
SELECT 
    month,
    revenue,
    LAG(revenue, 12) OVER (ORDER BY month) as revenue_year_ago,
    ROUND(((revenue - LAG(revenue, 12) OVER (ORDER BY month)) / 
           NULLIF(LAG(revenue, 12) OVER (ORDER BY month), 0)) * 100, 2) as yoy_growth_pct
FROM monthly_revenue_summary;
```

## Customer Analytics

### RFM Analysis (Recency, Frequency, Monetary)

#### Recency Score
**Definition**: Days since customer's last order
**Scoring**: 4 = Most Recent (≤25th percentile), 1 = Least Recent (≥75th percentile)
**Business Context**: Identifies customer engagement level

#### Frequency Score  
**Definition**: Total number of orders per customer
**Scoring**: 4 = Highest Frequency (≥75th percentile), 1 = Lowest Frequency (≤25th percentile)
**Business Context**: Measures customer loyalty and repeat purchase behavior

#### Monetary Score
**Definition**: Total customer spend
**Scoring**: 4 = Highest Spend (≥75th percentile), 1 = Lowest Spend (≤25th percentile)
**Business Context**: Identifies high-value customers

```sql
-- RFM Scoring Example
WITH customer_rfm AS (
    SELECT 
        customer_id,
        CURRENT_DATE - MAX(order_date) as recency_days,
        COUNT(DISTINCT order_id) as frequency,
        SUM(unit_price * quantity * (1 - discount)) as monetary
    FROM customer_orders_view
    GROUP BY customer_id
)
SELECT 
    customer_id,
    NTILE(4) OVER (ORDER BY recency_days) as recency_score,
    NTILE(4) OVER (ORDER BY frequency DESC) as frequency_score,
    NTILE(4) OVER (ORDER BY monetary DESC) as monetary_score
FROM customer_rfm;
```

### Customer Segments
- **Champions (444)**: High recency, frequency, and monetary scores
- **Loyal Customers (334-443)**: Good across all dimensions
- **At Risk (144-244)**: Low recency, high frequency/monetary
- **Lost Customers (111-244)**: Poor performance across dimensions

### Customer Lifetime Value (CLV)
**Definition**: Total revenue generated by a customer over their lifetime
**Formula**: `Total Customer Revenue / Customer Lifetime Days * 365`
**Business Context**: Identifies most valuable customers for retention efforts

## Competitive Intelligence

### Price Conversion
**Amazon INR to USD**: `Price_INR / 83` (approximate exchange rate)
**Olist BRL to USD**: `Price_BRL / 4` (approximate exchange rate)
**Business Context**: Enables global price comparisons

### Discount Effectiveness
**Discount Percentage**: Already provided in Amazon data
**Price Positioning**:
- **Premium**: >20% above market average
- **Competitive**: ±20% of market average  
- **Value**: >20% below market average

### Market Position Matrix
**Quality Score**: `(Rating - 1) * 25` (normalized to 0-100 scale)
**Price Percentile**: Relative position within category price range
**Quadrants**:
- **Premium**: High quality (>80), High price (>70th percentile)
- **Value**: High quality (>80), Low price (<30th percentile)
- **Overpriced**: Low quality (<60), High price (>70th percentile)
- **Budget**: Low quality (<60), Low price (<30th percentile)

## Statistical Calculations

### Percentile Calculations
```sql
-- Standard percentile calculation for pricing analysis
SELECT 
    category,
    PERCENTILE_CONT(0.25) WITHIN GROUP (ORDER BY price) as q1_price,
    PERCENTILE_CONT(0.50) WITHIN GROUP (ORDER BY price) as median_price,
    PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY price) as q3_price
FROM product_prices
GROUP BY category;
```

### Moving Averages
**3-Month Moving Average**: `AVG(value) OVER (ORDER BY date ROWS BETWEEN 2 PRECEDING AND CURRENT ROW)`
**Purpose**: Smooth out short-term fluctuations in trend analysis

### Outlier Detection
**Standard Deviation Method**: Values outside ±2 standard deviations
**IQR Method**: Values outside Q1 - 1.5*IQR or Q3 + 1.5*IQR

## Performance Benchmarks

### Industry Standards
- **E-commerce Growth Rate**: 20.5% annually
- **Average Order Value**: $53 (Amazon Prime Day benchmark)
- **Customer Retention Rate**: 75% (industry average)
- **Cart Abandonment Rate**: 69.8% (typical e-commerce)

### Query Performance Targets
- **Dashboard Queries**: <1 second execution time
- **Complex Analytics**: <5 seconds execution time
- **Data Import Operations**: <10 minutes for full dataset

## Data Quality Standards

### Acceptable Ranges
- **Product Prices**: >$0, <$10,000
- **Ratings**: 1.0 - 5.0 scale
- **Discounts**: 0% - 100%
- **Order Dates**: Within reasonable business timeframe

### NULL Value Handling
- **Revenue Calculations**: Use `COALESCE(value, 0)` to prevent NULL results
- **Division Operations**: Use `NULLIF(denominator, 0)` to prevent divide-by-zero
- **Date Comparisons**: Exclude NULL dates from time-series analysis

## Currency Handling

### Exchange Rates (Approximate)
- **USD/INR**: 1 USD = 83 INR
- **USD/BRL**: 1 USD = 4 BRL
- **Last Updated**: 2024 rates (update quarterly)

### Conversion Functions
```sql
-- Currency conversion utilities
CREATE FUNCTION convert_inr_to_usd(price_inr DECIMAL) RETURNS DECIMAL AS $$
BEGIN
    RETURN ROUND(price_inr / 83, 2);
END;
$$ LANGUAGE plpgsql IMMUTABLE;
```

## Validation Rules

### Business Logic Validation
1. **Revenue Integrity**: `unit_price * quantity * (1 - discount) > 0`
2. **Date Consistency**: `shipped_date >= order_date`
3. **Discount Logic**: `discount >= 0 AND discount <= 1`
4. **Price Consistency**: `discounted_price <= actual_price`

### Data Completeness
- **Critical Fields**: order_date, customer_id, product_id cannot be NULL
- **Revenue Components**: unit_price, quantity must be > 0
- **Rating Validation**: Must be between 1.0 and 5.0

## Materialized View Refresh Schedule

### High Priority (Hourly)
- `executive_kpi_summary`
- `customer_health_dashboard`

### Medium Priority (Daily)
- `revenue_trends_summary`
- `customer_rfm_summary`
- `competitive_positioning_matrix`

### Low Priority (Weekly)
- `category_price_analysis`
- Historical trend analysis views

## Business Intelligence Insights

### Key Questions Answered
1. **Revenue Performance**: "How is our revenue trending compared to last year?"
2. **Customer Health**: "Which customer segments need attention?"
3. **Competitive Position**: "How do our prices compare to Amazon?"
4. **Market Opportunities**: "Where can we improve our positioning?"

### Actionable Recommendations
- **Champions**: Reward with early access to new products
- **At Risk**: Targeted email campaigns with personalized offers
- **Price Positioning**: Adjust pricing based on competitive analysis
- **Product Mix**: Focus on high-margin, high-rating categories

## Implementation Notes

### PostgreSQL-Specific Features
- **Window Functions**: Used for ranking and moving averages
- **CTEs**: Break complex queries into readable components
- **JSONB**: Store flexible data structures for import logs
- **Materialized Views**: Pre-calculate expensive aggregations

### Performance Optimization
- **Indexes**: Created on frequently queried columns (dates, customer_id, product_id)
- **Partitioning**: Consider for large historical datasets
- **Query Optimization**: Use EXPLAIN ANALYZE for performance tuning

## Maintenance and Updates

### Monthly Tasks
- Refresh exchange rates
- Validate data quality metrics
- Update industry benchmarks
- Review materialized view performance

### Quarterly Tasks
- Analyze customer segment migrations
- Update competitive intelligence data
- Review and adjust KPI targets
- Performance optimization review

---

*Last Updated: 2025-01-01*  
*Version: 1.0*  
*Contact: Analytics Team*